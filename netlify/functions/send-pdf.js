// netlify/functions/send-pdf.js
const sgMail = require("@sendgrid/mail");
sgMail.setApiKey(process.env.SENDGRID_API_KEY);

exports.handler = async (event) => {
  if (event.headers["x-api-key"] !== process.env.FUNC_API_KEY) {
    return { statusCode: 401, body: "Unauthorized" };
  }
  const { customer, pdfDataUri } = JSON.parse(event.body);
  const base64 = pdfDataUri.split(",")[1];
  const msg = {
    to:   "your.team@muriphys.com",
    from: "no-reply@muriphys.com",
    subject: `New PDF from ${customer.name || "Unknown"}`,
    text:    `PDF generated by ${customer.name} <${customer.email}>.`,
    attachments: [{
      content:     base64,
      filename:    "Muriphys_Project_Summary.pdf",
      type:        "application/pdf",
      disposition: "attachment"
    }]
  };
  try {
    await sgMail.send(msg);
    return { statusCode: 200, body: "Email sent" };
  } catch (err) {
    console.error(err);
    return { statusCode: 500, body: "Failed to send email" };
  }
};